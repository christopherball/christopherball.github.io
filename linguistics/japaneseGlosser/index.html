<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <title>Japanese Glosser</title>
        <style>
            body {
                background-color: #1e1e2e;
                color: #e0e0e0;
                font-family: "Hiragino Kaku Gothic Pro", "Meiryo", sans-serif;
            }
            .container {
                position: relative;
                display: inline-block;
                font-size: 2em;
                margin-bottom: 6em;
            }
            #jpText {
                position: relative;
                z-index: 1;
                line-height: 3;
            }
            #jpText:focus {
                outline: none;
            }
            .gloss-layer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 0;
            }
            .gloss {
                position: absolute;
                pointer-events: auto;
                transform: translateX(-50%);
                font-size: 14px;
                cursor: default;
                text-align: center;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            .underlined {
                text-decoration: underline;
                text-decoration-thickness: 1.6px;
                text-underline-offset: 4px;
                margin-right: 3px;
            }
            #controls {
                margin-bottom: 18px;
                gap: 8px;
                align-items: center;
            }
            input {
                width: 250px;
            }
            button {
                width: 100px;
            }
            rt {
                color: #878787 !important;
            }

            .color-picker-container {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }

            .color-square {
                width: 15px;
                height: 15px;
                cursor: pointer;
            }
            .red {
                color: #ff7474;
            }
            .yellow {
                color: #ffff4a;
            }
            .green {
                color: #64b564;
            }
            .selected {
                text-decoration: underline;
                text-decoration-thickness: 1.6px;
                text-underline-offset: 4px;
            }
        </style>
    </head>
    <body>
        <h3>Japanese Glosser</h3>
        <div id="controls">
            <input id="textInput" placeholder="(Japanese)" />
            <button id="addText">Add Text</button>
            <br />
            <input id="glossInput" placeholder="(English)" />
            <button id="addGloss" disabled="true">Add Gloss</button>
            <span id="lastSelectionTextPreview"></span>
            <div class="color-picker-container">
                <div id="greenSquare" class="color-square green selected">
                    ■
                </div>
                <div id="yellowSquare" class="color-square yellow">■</div>
                <div id="redSquare" class="color-square red">■</div>
            </div>
        </div>

        <div class="container" id="container">
            <div id="jpText" tabindex="0"></div>
            <div class="gloss-layer" id="glossLayer"></div>
        </div>

        <script>
            const uid = () => "g" + Math.random().toString(36).slice(2, 9);
            const addTextBtn = document.getElementById("addText");
            const textInput = document.getElementById("textInput");
            const addGlossBtn = document.getElementById("addGloss");
            const glossInput = document.getElementById("glossInput");
            const glossLayer = document.getElementById("glossLayer");
            const container = document.getElementById("container");

            var lastSelectionText = null;
            var lastSelectionRange = null;

            addTextBtn.addEventListener("click", () => {
                const text = textInput.value.trim();
                document.getElementById("jpText").innerHTML = text;
            });

            addGlossBtn.addEventListener("click", () => {
                const text = glossInput.value.trim();
                if (!text) return alert("Enter a gloss first.");
                if (lastSelectionRange == null)
                    return alert("Select some Japanese text first.");
                const range = lastSelectionRange;
                if (!container.contains(range.commonAncestorContainer))
                    return alert("Select some Japanese text first.");

                const rect = range.getClientRects()[0];
                if (!rect || rect.width === 0)
                    return alert("Invalid selection.");
                const containerRect = container.getBoundingClientRect();
                const centerX = rect.left - containerRect.left + rect.width / 2;
                const topY = rect.bottom - containerRect.top + 6;

                lastSelectionRange = null;
                lastSelectionText = null;
                document.getElementById("lastSelectionTextPreview").innerText =
                    "";
                document.getElementById("addGloss").disabled = true;

                // Wrap selected content safely
                const frag = range.extractContents();
                const span = document.createElement("span");
                const glossId = uid();
                span.className =
                    "underlined " +
                    document
                        .querySelector(".color-square.selected")
                        .id.replace("Square", "");
                span.dataset.glossId = glossId;
                span.appendChild(frag);
                range.insertNode(span);

                const box = document.createElement("div");
                box.className =
                    "gloss " +
                    document
                        .querySelector(".color-square.selected")
                        .id.replace("Square", "");
                box.dataset.glossId = glossId;
                box.textContent = text;
                box.style.left = `${centerX}px`;
                box.style.top = `${topY}px`;
                box.style.maxWidth = `${rect.width}px`; // limit width to selection width
                glossLayer.appendChild(box);

                glossInput.value = "";
            });

            window.addEventListener("keydown", (e) => {
                if (e.key === "Enter") addGlossBtn.click();
            });

            document.addEventListener("mouseup", function () {
                const selectedText = window.getSelection().toString();
                const selectedRange = window.getSelection().getRangeAt(0);
                if (selectedText.length > 0) {
                    lastSelectionText = selectedText;
                    lastSelectionRange = selectedRange;
                    document.getElementById("addGloss").disabled = false;
                    document.getElementById(
                        "lastSelectionTextPreview"
                    ).innerText = "(to: " + lastSelectionText + ")";
                }
            });

            document.addEventListener("DOMContentLoaded", () => {
                const redSquare = document.getElementById("redSquare");
                const yellowSquare = document.getElementById("yellowSquare");
                const greenSquare = document.getElementById("greenSquare");

                const colorSquares = [redSquare, yellowSquare, greenSquare];

                colorSquares.forEach((square) => {
                    square.addEventListener("click", () => {
                        colorSquares.forEach((s) =>
                            s.classList.remove("selected")
                        );

                        square.classList.add("selected");
                    });
                });
            });
        </script>
    </body>
</html>
