<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <title>Japanese Glosser</title>
        <style>
            body {
                background-color: #1e1e2e;
                color: #e0e0e0;
                font-family: "Hiragino Sans", "Meiryo", sans-serif;
            }

            .container {
                position: relative;
                display: inline-block;
                font-size: 2em;
                margin-bottom: 6em;
            }

            #jpText {
                position: relative;
                z-index: 1;
                line-height: 2.2;
                font-weight: 200;
            }

            #jpText:focus {
                outline: none;
            }

            .gloss-layer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 0;
            }

            .gloss {
                position: absolute;
                pointer-events: auto;
                font-size: 12px;
                cursor: default;
                text-align: center;
                word-wrap: break-word;
                overflow-wrap: break-word;
                border-left: 1px grey solid;
                border-right: 1px grey solid;
            }

            .underlined {
                text-decoration: underline;
                text-decoration-thickness: 1.6px;
                text-underline-offset: 4px;
            }

            #controls {
                gap: 8px;
                align-items: center;
            }

            input {
                width: 448px;
                border: 2px solid transparent;
            }

            button {
                width: 88px;
                cursor: pointer;
                border: 2px solid transparent;
                border-radius: 0px;
            }

            rt {
                color: #878787 !important;
            }

            .color-picker-container {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }

            .color-square {
                width: 15px;
                height: 15px;
                cursor: pointer;
            }

            .red {
                color: #ff7474;
            }

            .orange {
                color: orange;
            }

            .yellow {
                color: #ffff4a;
            }

            .green {
                color: #64b564;
            }

            .blue {
                color: rgb(45, 213, 255);
            }

            .violet {
                color: violet;
            }

            .redBg {
                background-color: #ff7474;
            }

            .orangeBg {
                background-color: orange;
            }

            .yellowBg {
                background-color: #ffff4a;
            }

            .greenBg {
                background-color: #64b564;
            }

            .blueBg {
                background-color: rgb(45, 213, 255);
            }

            .violetBg {
                background-color: violet;
            }

            .selected {
                text-decoration: underline;
                text-decoration-thickness: 1.6px;
                text-underline-offset: 4px;
            }

            label {
                font-size: 12px;
            }

            .presetDescriptions {
                font-size: 12px;
                margin-top: 6px;
            }

            .presets button {
                width: 87px;
                padding: 0px;
                height: 32px;
            }

            table {
                width: 549px;
                border: 1px grey solid;
            }

            td:first-child,
            .column:first-child {
                padding-right: 5px;
            }

            .letter {
                font-weight: bold;
            }

            #lastSelectionTextPreview {
                padding-left: 3px;
                font-size: 12px;
            }

            summary {
                font-size: 12px;
            }

            .presets {
                padding-top: 4px;
            }

            .spacer {
                height: 1px;
            }
        </style>
    </head>
    <body>
        <h3>Japanese Glosser</h3>
        <div id="controls">
            <div class="color-picker-container">
                <div id="violetSquare" class="color-square violet selected">
                    ■
                </div>
                <div id="blueSquare" class="color-square blue">■</div>
                <div id="greenSquare" class="color-square green">■</div>
                <div id="yellowSquare" class="color-square yellow">■</div>
                <div id="orangeSquare" class="color-square orange">■</div>
                <div id="redSquare" class="color-square red">■</div>
            </div>
            <input id="textInput" placeholder="(Japanese)" />
            <button id="addText">Add Text</button>
            <div class="spacer"><br /></div>
            <input id="glossInput" placeholder="(English)" />
            <button id="addGloss" disabled="true">Add Gloss</button>
            <span id="lastSelectionTextPreview"></span>
            <div class="presets">
                <button id="addCircumstance" class="violetBg" disabled="true">
                    Circumstance
                </button>
                <button id="addAction" class="blueBg" disabled="true">
                    Action
                </button>
                <button id="addStyle" class="greenBg" disabled="true">
                    Style
                </button>
                <button id="addTime" class="yellowBg" disabled="true">
                    Time
                </button>
                <button id="addLocation" class="orangeBg" disabled="true">
                    Location
                </button>
                <button id="addEntity" class="redBg" disabled="true">
                    Entity
                </button>
            </div>
            <details>
                <summary>Details</summary>
                <div class="presetDescriptions">
                    <div class="table-container">
                        <table>
                            <tbody>
                                <tr>
                                    <td>
                                        <span class="violet letter">C</span
                                        >ircumstance
                                    </td>
                                    <td>
                                        The situation that brings about or
                                        allows the action.
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="blue letter">A</span>ction
                                    </td>
                                    <td>What happens.</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="green letter">S</span>tyle
                                    </td>
                                    <td>
                                        How the action occurs (qualitative).
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="yellow letter">T</span>ime
                                    </td>
                                    <td>When the action occurs.</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="orange letter">L</span
                                        >ocation
                                    </td>
                                    <td>Where the action occurs.</td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="red letter">E</span>ntity
                                    </td>
                                    <td>Who or what performs the action.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </details>
        </div>

        <div class="container" id="container">
            <div id="jpText" tabindex="0"></div>
            <div class="gloss-layer" id="glossLayer"></div>
        </div>

        <script>
            const uid = () => "g" + Math.random().toString(36).slice(2, 9);
            const addTextBtn = document.getElementById("addText");
            const addEntityBtn = document.getElementById("addEntity");
            const addLocationBtn = document.getElementById("addLocation");
            const addTimeBtn = document.getElementById("addTime");
            const addCircumstanceBtn =
                document.getElementById("addCircumstance");
            const addStyleBtn = document.getElementById("addStyle");
            const addActionBtn = document.getElementById("addAction");
            const textInput = document.getElementById("textInput");
            const addGlossBtn = document.getElementById("addGloss");
            const glossInput = document.getElementById("glossInput");
            const glossLayer = document.getElementById("glossLayer");
            const container = document.getElementById("container");

            var lastSelectionText = null;
            var lastSelectionRange = null;

            addTextBtn.addEventListener("click", () => {
                let text = textInput.value.trim();
                text = text.replace(/。/g, "。<br/>");

                document.getElementById("jpText").innerHTML = text;
                document.getElementById("glossLayer").innerHTML = "";
            });

            addCircumstanceBtn.addEventListener("click", () => {
                if (!isSelectionInSpan()) {
                    glossInput.value = "C";
                    document.getElementById("violetSquare").click();
                    addGlossBtn.click();
                }
            });

            addActionBtn.addEventListener("click", () => {
                if (!isSelectionInSpan()) {
                    glossInput.value = "A";
                    document.getElementById("blueSquare").click();
                    addGlossBtn.click();
                }
            });

            addStyleBtn.addEventListener("click", () => {
                if (!isSelectionInSpan()) {
                    glossInput.value = "S";
                    document.getElementById("greenSquare").click();
                    addGlossBtn.click();
                }
            });

            addTimeBtn.addEventListener("click", () => {
                if (!isSelectionInSpan()) {
                    glossInput.value = "T";
                    document.getElementById("yellowSquare").click();
                    addGlossBtn.click();
                }
            });

            addLocationBtn.addEventListener("click", () => {
                if (!isSelectionInSpan()) {
                    glossInput.value = "L";
                    document.getElementById("orangeSquare").click();
                    addGlossBtn.click();
                }
            });

            addEntityBtn.addEventListener("click", () => {
                if (!isSelectionInSpan()) {
                    glossInput.value = "E";
                    document.getElementById("redSquare").click();
                    addGlossBtn.click();
                }
            });

            addGlossBtn.addEventListener("click", () => {
                const text = glossInput.value.trim();
                if (!text) return alert("Enter a gloss first.");
                if (lastSelectionRange == null)
                    return alert("Select some Japanese text first.");
                const range = lastSelectionRange;
                if (!container.contains(range.commonAncestorContainer))
                    return alert("Select some Japanese text first.");

                const rect = range.getClientRects()[0];
                if (!rect || rect.width === 0)
                    return alert("Invalid selection.");
                const containerRect = container.getBoundingClientRect();
                const centerX = rect.left - containerRect.left + rect.width / 2;
                const topY = rect.bottom - containerRect.top + 3;

                // Wrap selected content safely
                const frag = range.extractContents();
                const span = document.createElement("span");
                const glossId = uid();
                span.className =
                    "underlined " +
                    document
                        .querySelector(".color-square.selected")
                        .id.replace("Square", "");
                span.dataset.glossId = glossId;
                span.appendChild(frag);
                range.insertNode(span);

                const box = document.createElement("div");
                box.className =
                    "gloss " +
                    document
                        .querySelector(".color-square.selected")
                        .id.replace("Square", "");
                box.dataset.glossId = glossId;
                box.textContent = text;
                box.style.left = `${Math.round(centerX)}px`;
                box.style.top = `${Math.round(topY)}px`;
                box.style.maxWidth = `${Math.round(rect.width) - 1}px`; // limit width to selection width
                box.style.width = `${Math.round(rect.width) - 1}px`;
                box.style.transform = `translateX(-${Math.round(rect.width / 2)}px)`;
                glossLayer.appendChild(box);

                resetState();
            });

            function resetState() {
                lastSelectionRange = null;
                lastSelectionText = null;
                document.getElementById("lastSelectionTextPreview").innerText =
                    "";
                document.getElementById("addGloss").disabled = true;
                document.querySelectorAll(".presets button").forEach((b) => {
                    b.disabled = true;
                });
                glossInput.value = "";
                window.getSelection().removeAllRanges();
            }

            window.addEventListener("keydown", (e) => {
                const glossInput = document.getElementById("glossInput");

                if (e.key === "Enter") addGlossBtn.click();
                else if (e.key === "Delete") removeFormatting();
                else if (e.key === "1" && document.activeElement != glossInput)
                    addCircumstanceBtn.click();
                else if (e.key === "2" && document.activeElement != glossInput)
                    addActionBtn.click();
                else if (e.key === "3" && document.activeElement != glossInput)
                    addStyleBtn.click();
                else if (e.key === "4" && document.activeElement != glossInput)
                    addTimeBtn.click();
                else if (e.key === "5" && document.activeElement != glossInput)
                    addLocationBtn.click();
                else if (e.key === "6" && document.activeElement != glossInput)
                    addEntityBtn.click();
            });

            document.addEventListener("mouseup", function () {
                if (
                    containsHtml(getSelectionHtml()) ||
                    (isSelectionInSpan() && !isEntireParentSelected())
                ) {
                    document.execCommand("copy");
                    resetState();
                    return;
                } else {
                    document.execCommand("copy");
                }

                const selectedText = window.getSelection().toString();
                if (selectedText.length > 0) {
                    lastSelectionText = selectedText;
                    if (window.getSelection().rangeCount > 0) {
                        lastSelectionRange = window
                            .getSelection()
                            .getRangeAt(0);
                    }
                    document.getElementById("addGloss").disabled = false;
                    document
                        .querySelectorAll(".presets button")
                        .forEach((b) => {
                            b.disabled = false;
                        });
                    document.getElementById(
                        "lastSelectionTextPreview",
                    ).innerText =
                        " ► " + truncateWithLastChar(lastSelectionText, 30);
                }
            });

            document.addEventListener("DOMContentLoaded", () => {
                const redSquare = document.getElementById("redSquare");
                const orangeSquare = document.getElementById("orangeSquare");
                const yellowSquare = document.getElementById("yellowSquare");
                const greenSquare = document.getElementById("greenSquare");
                const blueSquare = document.getElementById("blueSquare");
                const violetSquare = document.getElementById("violetSquare");

                const colorSquares = [
                    redSquare,
                    orangeSquare,
                    yellowSquare,
                    greenSquare,
                    blueSquare,
                    violetSquare,
                ];

                colorSquares.forEach((square) => {
                    square.addEventListener("click", () => {
                        colorSquares.forEach((s) =>
                            s.classList.remove("selected"),
                        );

                        square.classList.add("selected");
                    });
                });
            });

            function truncateWithLastChar(str, maxLength) {
                // Return the original string if it's already within the limit
                if (str.length <= maxLength) {
                    return str;
                }

                // Calculate the content length before the ellipsis.
                // We need to keep room for the '...' (3 characters) and the final char (1 character).
                // Total removed is 4 (3 for '...' + 1 for last character).
                const allowedLength = maxLength - 4;

                // Take the start of the string, add "...", and append the very last character
                return str.slice(0, allowedLength) + "..." + str.slice(-1);
            }

            function getSelectionHtml() {
                let html = "";
                if (typeof window.getSelection != "undefined") {
                    const sel = window.getSelection();
                    if (sel.rangeCount) {
                        const container = document.createElement("div");
                        for (let i = 0, len = sel.rangeCount; i < len; ++i) {
                            container.appendChild(
                                sel.getRangeAt(i).cloneContents(),
                            );
                        }
                        html = container.innerHTML;
                    }
                } else if (typeof document.selection != "undefined") {
                    // Fallback for older IE (if needed)
                    if (document.selection.type == "Text") {
                        html = document.selection.createRange().htmlText;
                    }
                }
                return html;
            }

            function containsHtml(str) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(str, "text/html");
                // Check if the body contains any element nodes (nodeType === 1)
                return Array.from(doc.body.childNodes).some(
                    (node) => node.nodeType === 1,
                );
            }

            function getSelectionContainerAttribute(attributeName) {
                const selection = window.getSelection();

                // Check if there is an active selection
                if (!selection || selection.rangeCount === 0) {
                    return null;
                }

                // Get the first range of the selection
                const range = selection.getRangeAt(0);

                // Get the common ancestor container node
                let container = range.commonAncestorContainer;

                // If the container is a text node, get its parent element
                if (container.nodeType !== Node.ELEMENT_NODE) {
                    container = container.parentNode;
                }

                // Check if the container is an actual element before trying to get an attribute
                if (container && container.nodeType === Node.ELEMENT_NODE) {
                    return container.getAttribute(attributeName);
                }

                return null;
            }

            function isSelectionInSpan() {
                const selection = window.getSelection();
                if (!selection.rangeCount) return false;

                const container =
                    selection.getRangeAt(0).commonAncestorContainer;
                const parentElement =
                    container.nodeType === Node.ELEMENT_NODE
                        ? container
                        : container.parentElement;

                // Checks if the container itself OR any parent is a span
                return !!parentElement.closest("span");
            }

            function isEntireParentSelected() {
                const selection = window.getSelection();

                // Basic validation for an active selection
                if (!selection.rangeCount || selection.isCollapsed)
                    return false;

                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;

                // Get the immediate element parent
                const parentElement =
                    container.nodeType === Node.ELEMENT_NODE
                        ? container
                        : container.parentElement;

                // Use .trim() to prevent failures from accidental leading/trailing whitespace
                const selectedText = selection.toString().trim();
                const parentText = parentElement.innerText.trim();

                return selectedText === parentText && selectedText.length > 0;
            }

            function removeFormatting() {
                const targetId =
                    getSelectionContainerAttribute("data-gloss-id");
                const searchValue = lastSelectionText;
                const jpDiv = document.getElementById("jpText");
                const glossDiv = document.getElementById("glossLayer");

                if (searchValue == null) return;

                const escaped = searchValue.replace(
                    /[.*+?^${}()|[\]\\]/g,
                    "\\$&",
                );

                const regex = new RegExp(
                    `<span[^>]*data-gloss-id="${targetId}"[^>]*>${escaped}</span>`,
                );

                const replacementHTML = jpDiv.innerHTML.replace(
                    regex,
                    searchValue,
                );

                const inboundChange = replacementHTML != jpDiv.innerHTML;
                jpDiv.innerHTML = replacementHTML;

                if (inboundChange) {
                    const selector = `div[data-gloss-id="${targetId}"]`;
                    const elementToRemove = document.querySelector(selector);
                    if (elementToRemove) elementToRemove.remove();
                    resetState();
                }
            }
        </script>
    </body>
</html>
