<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <title>Japanese Glosser</title>
        <style>
            body {
                background-color: #1e1e2e;
                color: #e0e0e0;
                font-family: "Hiragino Kaku Gothic Pro", "Meiryo", sans-serif;
            }
            .container {
                position: relative;
                display: inline-block;
                font-size: 2em;
                margin-bottom: 6em;
            }
            #jpText {
                position: relative;
                z-index: 1;
                line-height: 3;
            }
            #jpText:focus {
                outline: none;
            }
            .gloss-layer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 0;
            }
            .gloss {
                position: absolute;
                pointer-events: auto;
                transform: translateX(-50%);
                font-size: 14px;
                cursor: default;
                text-align: center;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            .underlined {
                text-decoration: underline;
                text-decoration-thickness: 1.6px;
                text-underline-offset: 4px;
                margin-right: 3px;
            }
            #controls {
                margin-bottom: 18px;
                gap: 8px;
                align-items: center;
            }
            input {
                width: 250px;
            }
            button {
                width: 100px;
            }
            rt {
                color: #878787 !important;
            }

            .color-picker-container {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }

            .color-square {
                width: 15px;
                height: 15px;
                cursor: pointer;
            }

            .red {
                color: #ff7474;
            }

            .orange {
                color: orange;
            }

            .yellow {
                color: #ffff4a;
            }

            .green {
                color: #64b564;
            }

            .blue {
                color: rgb(45, 213, 255);
            }

            .violet {
                color: violet;
            }

            .redBg {
                background-color: #ff7474;
            }

            .orangeBg {
                background-color: orange;
            }

            .yellowBg {
                background-color: #ffff4a;
            }

            .greenBg {
                background-color: #64b564;
            }

            .blueBg {
                background-color: rgb(45, 213, 255);
            }

            .violetBg {
                background-color: violet;
            }

            .selected {
                text-decoration: underline;
                text-decoration-thickness: 1.6px;
                text-underline-offset: 4px;
            }

            .sectionHeader,
            label {
                font-size: 12px;
            }

            .presets button {
                width: 56px;
                padding: 0px;
                height: 42px;
            }

            input[type="checkbox"] {
                width: 20px;
            }
        </style>
    </head>
    <body>
        <h3>Japanese Glosser</h3>
        <div id="controls">
            <input id="textInput" placeholder="(Japanese)" />
            <button id="addText">Add Text</button>
            <input type="checkbox" id="sentenceBreak" checked />
            <label for="sentenceBreak">Sentence Breaks</label>
            <br />
            <input id="glossInput" placeholder="(English)" />
            <button id="addGloss" disabled="true">Add Gloss</button>
            <span id="lastSelectionTextPreview"></span>
            <div class="color-picker-container">
                <div id="violetSquare" class="color-square violet selected">
                    ■
                </div>
                <div id="blueSquare" class="color-square blue">■</div>
                <div id="greenSquare" class="color-square green">■</div>
                <div id="yellowSquare" class="color-square yellow">■</div>
                <div id="orangeSquare" class="color-square orange">■</div>
                <div id="redSquare" class="color-square red">■</div>
            </div>
            <div class="sectionHeader">Event Structure Presets</div>
            <div class="presets">
                <button id="addActor" class="violetBg" disabled="true">
                    Actor<br />1
                </button>
                <button id="addLocation" class="blueBg" disabled="true">
                    Location<br />2
                </button>
                <button id="addTime" class="greenBg" disabled="true">
                    Time<br />3
                </button>
                <button id="addReason" class="yellowBg" disabled="true">
                    Reason<br />4
                </button>
                <button id="addManner" class="orangeBg" disabled="true">
                    Manner<br />5
                </button>
                <button id="addAction" class="redBg" disabled="true">
                    Action<br />6
                </button>
            </div>
        </div>

        <div class="container" id="container">
            <div id="jpText" tabindex="0"></div>
            <div class="gloss-layer" id="glossLayer"></div>
        </div>

        <script>
            const uid = () => "g" + Math.random().toString(36).slice(2, 9);
            const addTextBtn = document.getElementById("addText");
            const addActorBtn = document.getElementById("addActor");
            const addLocationBtn = document.getElementById("addLocation");
            const addTimeBtn = document.getElementById("addTime");
            const addReasonBtn = document.getElementById("addReason");
            const addMannerBtn = document.getElementById("addManner");
            const addActionBtn = document.getElementById("addAction");
            const textInput = document.getElementById("textInput");
            const addGlossBtn = document.getElementById("addGloss");
            const glossInput = document.getElementById("glossInput");
            const glossLayer = document.getElementById("glossLayer");
            const container = document.getElementById("container");

            var lastSelectionText = null;
            var lastSelectionRange = null;

            addTextBtn.addEventListener("click", () => {
                let text = textInput.value.trim();
                if (document.getElementById("sentenceBreak").checked) {
                    text = text.replace(/。/g, "。<br/>");
                }
                document.getElementById("jpText").innerHTML = text;
                document.getElementById("glossLayer").innerHTML = "";
            });

            addActorBtn.addEventListener("click", () => {
                glossInput.value = "actor";
                document.getElementById("violetSquare").click();
                addGlossBtn.click();
            });

            addLocationBtn.addEventListener("click", () => {
                glossInput.value = "location";
                document.getElementById("blueSquare").click();
                addGlossBtn.click();
            });

            addTimeBtn.addEventListener("click", () => {
                glossInput.value = "time";
                document.getElementById("greenSquare").click();
                addGlossBtn.click();
            });

            addReasonBtn.addEventListener("click", () => {
                glossInput.value = "reason";
                document.getElementById("yellowSquare").click();
                addGlossBtn.click();
            });

            addMannerBtn.addEventListener("click", () => {
                glossInput.value = "manner";
                document.getElementById("orangeSquare").click();
                addGlossBtn.click();
            });

            addActionBtn.addEventListener("click", () => {
                glossInput.value = "action";
                document.getElementById("redSquare").click();
                addGlossBtn.click();
            });

            addGlossBtn.addEventListener("click", () => {
                const text = glossInput.value.trim();
                if (!text) return alert("Enter a gloss first.");
                if (lastSelectionRange == null)
                    return alert("Select some Japanese text first.");
                const range = lastSelectionRange;
                if (!container.contains(range.commonAncestorContainer))
                    return alert("Select some Japanese text first.");

                const rect = range.getClientRects()[0];
                if (!rect || rect.width === 0)
                    return alert("Invalid selection.");
                const containerRect = container.getBoundingClientRect();
                const centerX = rect.left - containerRect.left + rect.width / 2;
                const topY = rect.bottom - containerRect.top + 6;

                // Wrap selected content safely
                const frag = range.extractContents();
                const span = document.createElement("span");
                const glossId = uid();
                span.className =
                    "underlined " +
                    document
                        .querySelector(".color-square.selected")
                        .id.replace("Square", "");
                span.dataset.glossId = glossId;
                span.appendChild(frag);
                range.insertNode(span);

                const box = document.createElement("div");
                box.className =
                    "gloss " +
                    document
                        .querySelector(".color-square.selected")
                        .id.replace("Square", "");
                box.dataset.glossId = glossId;
                box.textContent = text;
                box.style.left = `${centerX}px`;
                box.style.top = `${topY}px`;
                box.style.maxWidth = `${rect.width}px`; // limit width to selection width
                glossLayer.appendChild(box);

                resetState();
            });

            function resetState() {
                lastSelectionRange = null;
                lastSelectionText = null;
                document.getElementById("lastSelectionTextPreview").innerText =
                    "";
                document.getElementById("addGloss").disabled = true;
                document.querySelectorAll(".presets button").forEach((b) => {
                    b.disabled = true;
                });
                glossInput.value = "";
                window.getSelection().removeAllRanges();
            }

            window.addEventListener("keydown", (e) => {
                if (e.key === "Enter") addGlossBtn.click();
                else if (e.key === "Delete") removeFormatting();
                else if (e.key === "1") addActorBtn.click();
                else if (e.key === "2") addLocationBtn.click();
                else if (e.key === "3") addTimeBtn.click();
                else if (e.key === "4") addReasonBtn.click();
                else if (e.key === "5") addMannerBtn.click();
                else if (e.key === "6") addActionBtn.click();
            });

            document.addEventListener("mouseup", function () {
                if (
                    containsHtml(getSelectionHtml()) ||
                    (isSelectionInSpan() && !isEntireParentSelected())
                ) {
                    resetState();
                    return;
                }

                const selectedText = window.getSelection().toString();
                const selectedRange = window.getSelection().getRangeAt(0);
                if (selectedText.length > 0) {
                    lastSelectionText = selectedText;
                    lastSelectionRange = selectedRange;
                    document.getElementById("addGloss").disabled = false;
                    document
                        .querySelectorAll(".presets button")
                        .forEach((b) => {
                            b.disabled = false;
                        });
                    document.getElementById(
                        "lastSelectionTextPreview",
                    ).innerText = "(to: " + lastSelectionText + ")";
                }
            });

            document.addEventListener("DOMContentLoaded", () => {
                const redSquare = document.getElementById("redSquare");
                const orangeSquare = document.getElementById("orangeSquare");
                const yellowSquare = document.getElementById("yellowSquare");
                const greenSquare = document.getElementById("greenSquare");
                const blueSquare = document.getElementById("blueSquare");
                const violetSquare = document.getElementById("violetSquare");

                const colorSquares = [
                    redSquare,
                    orangeSquare,
                    yellowSquare,
                    greenSquare,
                    blueSquare,
                    violetSquare,
                ];

                colorSquares.forEach((square) => {
                    square.addEventListener("click", () => {
                        colorSquares.forEach((s) =>
                            s.classList.remove("selected"),
                        );

                        square.classList.add("selected");
                    });
                });
            });

            function getSelectionHtml() {
                let html = "";
                if (typeof window.getSelection != "undefined") {
                    const sel = window.getSelection();
                    if (sel.rangeCount) {
                        const container = document.createElement("div");
                        for (let i = 0, len = sel.rangeCount; i < len; ++i) {
                            container.appendChild(
                                sel.getRangeAt(i).cloneContents(),
                            );
                        }
                        html = container.innerHTML;
                    }
                } else if (typeof document.selection != "undefined") {
                    // Fallback for older IE (if needed)
                    if (document.selection.type == "Text") {
                        html = document.selection.createRange().htmlText;
                    }
                }
                return html;
            }

            function containsHtml(str) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(str, "text/html");
                // Check if the body contains any element nodes (nodeType === 1)
                return Array.from(doc.body.childNodes).some(
                    (node) => node.nodeType === 1,
                );
            }

            function getSelectionContainerAttribute(attributeName) {
                const selection = window.getSelection();

                // Check if there is an active selection
                if (!selection || selection.rangeCount === 0) {
                    return null;
                }

                // Get the first range of the selection
                const range = selection.getRangeAt(0);

                // Get the common ancestor container node
                let container = range.commonAncestorContainer;

                // If the container is a text node, get its parent element
                if (container.nodeType !== Node.ELEMENT_NODE) {
                    container = container.parentNode;
                }

                // Check if the container is an actual element before trying to get an attribute
                if (container && container.nodeType === Node.ELEMENT_NODE) {
                    return container.getAttribute(attributeName);
                }

                return null;
            }

            function isSelectionInSpan() {
                const selection = window.getSelection();
                if (!selection.rangeCount) return false;

                const container =
                    selection.getRangeAt(0).commonAncestorContainer;
                const parentElement =
                    container.nodeType === Node.ELEMENT_NODE
                        ? container
                        : container.parentElement;

                // Checks if the container itself OR any parent is a span
                return !!parentElement.closest("span");
            }

            function isEntireParentSelected() {
                const selection = window.getSelection();

                // Basic validation for an active selection
                if (!selection.rangeCount || selection.isCollapsed)
                    return false;

                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;

                // Get the immediate element parent
                const parentElement =
                    container.nodeType === Node.ELEMENT_NODE
                        ? container
                        : container.parentElement;

                // Use .trim() to prevent failures from accidental leading/trailing whitespace
                const selectedText = selection.toString().trim();
                const parentText = parentElement.innerText.trim();

                return selectedText === parentText && selectedText.length > 0;
            }

            function removeFormatting() {
                const targetId =
                    getSelectionContainerAttribute("data-gloss-id");
                const searchValue = lastSelectionText;
                const jpDiv = document.getElementById("jpText");
                const glossDiv = document.getElementById("glossLayer");

                if (searchValue == null) return;

                const escaped = searchValue.replace(
                    /[.*+?^${}()|[\]\\]/g,
                    "\\$&",
                );

                const regex = new RegExp(
                    `<span[^>]*data-gloss-id="${targetId}"[^>]*>${escaped}</span>`,
                );

                const replacementHTML = jpDiv.innerHTML.replace(
                    regex,
                    searchValue,
                );

                const inboundChange = replacementHTML != jpDiv.innerHTML;
                jpDiv.innerHTML = replacementHTML;

                if (inboundChange) {
                    const selector = `div[data-gloss-id="${targetId}"]`;
                    const elementToRemove = document.querySelector(selector);
                    if (elementToRemove) elementToRemove.remove();
                    resetState();
                }
            }
        </script>
    </body>
</html>
